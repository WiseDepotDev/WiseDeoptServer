# 慧仓智控服务端架构规划（含 Redis / MySQL / MinIO）

本文件基于《需求列表》《数据库设计表》《后端异常码对照表》对慧仓智控（WiseDeoptServer）服务端进行整体架构规划。

## 一、总体目标与约束

- 主要目标
  - 支撑 NFC + PIN 登录、角色与权限控制；
  - 支撑资产绑定、入库/出库、库存盘点与差异分析；
  - 支撑巡检小车自动盘点、设备心跳与状态监控；
  - 支撑告警事件联动（RFID-视频一致性、违规移动检测等）与报表导出；
  - 能够在比赛演示中直观展示「设备在线、告警、巡检、库存」等关键指标。
- 非功能约束
  - 架构以「模块化单体」为主：单个 Spring Boot 进程，内部按模块分层；
  - 使用 MySQL 作为主业务数据库；
  - 使用 Redis 作为缓存、会话和分布式控制组件；
  - 使用 MinIO 作为对象存储，承载文件类数据（视频截图、报表文件等）。

## 二、逻辑分层与模块划分

服务端代码按以下逻辑分层（对应现有工程模块）：

- 接口层（API）
  - 模块：`wise-deopt-api`
  - 责任：提供 HTTP/REST 接口，进行参数校验、鉴权与统一响应；
  - 典型接口：登录、资产 CRUD、库存查询、巡检任务管理、告警查询等。
- 应用层（Application）
  - 模块：`wise-deopt-application`
  - 责任：用例编排与事务控制，例如「创建入库单并更新库存」「巡检结果入库并推送告警」；
  - 与基础设施交互：通过接口调用仓储、消息、OSS、缓存等。
- 领域层（Domain）
  - 模块：`wise-deopt-domain`
  - 责任：承载领域模型（实体、值对象、领域服务）、业务规则与状态流转；
  - 示例：用户、权限、资产、库存、任务、设备、告警、报表等领域对象。
- 基础设施层（Infrastructure）
  - 模块：`wise-deopt-infrastructure`
  - 责任：对接 MySQL、Redis、MinIO 以及其他外部系统；
  - 内容：JPA/MyBatis 仓储实现、Redis 客户端封装、MinIO 客户端封装等。
- 通用模块（Common）
  - 模块：`wise-deopt-common`
  - 责任：统一返回体、通用异常、工具类、错误码枚举、日志封装等。

核心依赖方向为：`api → application → domain/infrastructure → common`。

## 三、按业务域划分的服务模块

结合《数据库设计表》中「所属数据库」「所属服务」字段，规划以下业务子模块（逻辑服务）：

- 用户与认证服务（user / auth）
  - 主要表：
    - `user_core`, `user_profile`, `user_security`, `nfc_badge`, `user_access_key`
    - `permission`, `role`, `user_role`, `role_permission`
    - 登录/令牌相关日志：`key_access_audit_log`, `user_login_log`
  - 职责：
    - 支持邮箱 + 密码登录、NFC 工牌 + PIN 登录、二步验证；
    - 管理用户、角色、权限与访问密钥；
    - 记录登录与密钥访问审计日志。
  - 与 Redis：
    - 存储登录会话（access token / refresh token）与登录失败计数；
    - 存储临时验证码、二步验证状态。

- 文件与对象存储服务（oss）
  - 主要表：
    - `minio_file`：记录 MinIO 对象的元数据（bucket、objectKey、大小、MD5 等）；
  - 职责：
    - 为前端与其他服务提供统一的文件上传、下载与删除接口；
    - 生成 MinIO 临时访问链接，控制有效期与权限；
    - 管理录像文件记录（与 `monitor_record`、`monitor_snapshot` 关联）。
  - 与 MinIO：
    - 将原始文件（视频片段、截图、报表导出文件）存储在对应 bucket 中；
    - 利用 MinIO SDK 管理对象生命周期与访问策略。

- 库存与标签服务（inventory / tag）
  - 主要表：
    - `product`, `inventory`（库存明细）, `product_tag`（RFID/条码标签）
  - 职责：
    - 管理物料与库存数量、位置；
    - 关联标签信息，支撑扫描中心与差异复核；
    - 提供库存台账与差异数据源。
  - 与 Redis：
    - 对高频查询的库存聚合结果进行缓存（例如首页 KPI 中的库存总量）；
    - 对热点商品或房间库存做短期缓存以减轻数据库压力。

- 出入库服务（inout）
  - 主要表：
    - `stock_order`, `stock_order_item`
  - 职责：
    - 管理入库/出库单及其明细；
    - 与库存服务联动，更新 `inventory` 中的数量与状态；
    - 对接告警服务，在未审批出库或违规移动时触发告警。

- 设备与监控服务（device / monitor）
  - 主要表：
    - 设备核心与类型：`device_core`, `device_rfid_reader`, `device_camera`, `device_inspection_robot`
    - 设备状态：`device_heartbeat_log`
    - 监控记录：`monitor_record`, `monitor_snapshot`
  - 职责：
    - 管理仓内 RFID 读写器、视频摄像头、巡检小车等设备；
    - 采集设备心跳，统计设备在线率；
    - 关联监控视频与截图，支撑 RFID-视频一致性与违规移动检测。
  - 与 Redis：
    - 缓存设备在线状态（如最近心跳时间、状态枚举）；
    - 存储短期设备心跳缓存，用于首页展示与实时监控。
  - 与 MinIO：
    - 存储监控视频片段与截图文件；
    - `monitor_record` 与 `monitor_snapshot` 通过 `minio_file` / objectKey 关联具体对象。

- 巡检服务（inspection）
  - 主要表：
    - `inspection_plan`, `inspection_task`, `inspection_detail`, `inspection_result_summary`
  - 职责：
    - 管理巡检计划（路线、周期）、任务生成与下发；
    - 接收巡检小车回传结果，更新明细与结果汇总；
    - 联动告警服务（如发现缺失/多余/未识别标签）。
  - 与 Redis：
    - 缓存当前执行中的巡检任务状态；
    - 保存任务队列或调度锁，避免重复下发任务。

- 告警服务（alert）
  - 主要表：
    - `alert_event`, `alert_handle_log`
  - 职责：
    - 统一管理 RFID-视频一致性异常、违规移动、设备离线等告警；
    - 记录告警处理过程，支撑前端的未处理告警列表与处理历史；
    - 与报表服务一起提供差异分析数据源。
  - 与 Redis：
    - 缓存最近未处理告警列表，用于首页快速展示；
    - 使用发布/订阅或流式数据（可选）实现告警实时推送。

- 报表服务（report）
  - 主要表：
    - `report_task`, `report_export_record`
  - 职责：
    - 根据需求列表提供库存台账、对账报表与差异分析报表；
    - 支持异步报表生成与导出，生成结果存储到 MinIO；
    - 通过 `report_export_record` 记录导出历史。
  - 与 Redis：
    - 缓存报表任务进度与摘要信息，便于前端轮询与刷新；
    - 控制报表任务并发数与限流。
  - 与 MinIO：
    - 存储报表导出文件（如 CSV、Excel、PDF），通过临时访问链接供前端下载。

## 四、MySQL 设计与库划分

结合《数据库设计表》中「所属数据库」字段，MySQL 侧建议采用「逻辑分库 + 单实例」方案：

- 单实例多逻辑库
  - 一个 MySQL 实例（竞赛环境中更易运维）；
  - 在该实例中创建多个逻辑数据库：
    - `user`（用户服务）
    - `auth`（认证授权）
    - `oss`（文件管理）
    - `inventory`（库存）
    - `tag`（标签）
    - `inout`（出入库）
    - `device`（设备）
    - `monitor`（监控）
    - `inspection`（巡检）
    - `report`（报表）
    - `alert`（告警）
  - 每个逻辑数据库下建表名称与《数据库设计表》保持一致。

- 映射关系
  - 基础设施层提供每个逻辑库对应的 DataSource / Repository；
  - 应用层通过仓储接口访问具体表，不直接关心数据源实现；
  - 在竞赛环境中可以根据需要，选择是否将部分逻辑库合并为同一个物理库以简化部署。

## 五、Redis 使用规划

Redis 作为缓存与分布式协调组件，建议统一使用一个实例，通过 key 前缀和逻辑 DB 区分用途：

- 推荐键空间规划
  - 认证与会话：
    - `auth:login:fail:{userId}` 登录失败计数，用于账户锁定逻辑；
    - `auth:token:access:{token}` 访问令牌缓存；
    - `auth:token:refresh:{token}` 刷新令牌缓存。
  - 验证与临时状态：
    - `auth:2fa:{verificationId}` 二步验证临时状态；
    - `user:reset-password:{token}` 重置密码临时令牌。
  - 缓存数据：
    - `dashboard:kpi` 首页 KPI 聚合数据（库存总量、今日报警数、巡检进度、设备在线数）；
    - `alert:unhandled:list` 最近未处理告警列表；
    - `inventory:summary:{roomId}` 某房间库存汇总；
    - `device:status:{deviceId}` 设备在线状态与最近心跳时间。
  - 分布式控制与限流：
    - `lock:inspection:task:{taskId}` 巡检任务调度锁；
    - `limit:report:generate:{userId}` 报表生成限流；
    - `lock:stock:order:{orderId}` 出入库单并发操作控制。

- 使用原则
  - 对于强一致性要求高的核心数据（如库存变动、账务等），以 MySQL 为准，Redis 只作缓存；
  - 缓存需设计合理的过期时间，保证数据不一致窗口可控；
  - 分布式锁与限流逻辑要考虑超时与降级策略，避免竞赛演示时出现死锁。

## 六、MinIO 使用规划

MinIO 作为对象存储服务，主要承载以下类型的文件：

- 文件类型与 bucket 规划
  - 监控视频与截图
    - Bucket：`wise-monitor-video`，存储监控录制的短视频或合成片段；
    - Bucket：`wise-monitor-snapshot`，存储监控截图、告警截图。
  - 报表导出文件
    - Bucket：`wise-report-export`，存储报表导出的 CSV/Excel/PDF 等文件；
  - 用户或资产相关附件（可选）
    - Bucket：`wise-asset-attach`，存储资产照片、说明书等。

- 元数据管理
  - `oss.minio_file` 表记录：
    - `file_id`（主键）
    - `bucket`（MinIO bucket 名称）
    - `object_key`（对象 key）
    - `size`、`content_type`、`hash` 等基本属性；
    - 关联业务字段（如所属报表任务、所属监控记录、所属资产等）。
  - 业务表（如 `monitor_record`, `monitor_snapshot`, `report_export_record`）中存储 `file_id` 或 `object_key` 与 `minio_file` 建立外键或逻辑关联。

- 访问控制与临时链接
  - 通过 MinIO SDK 生成临时访问链接，控制有效期（对应异常码 `VAL-RANGE-OSS-1001`）；
  - 统一处理 MinIO 相关异常，对应《后端异常码对照表》中 OSS 模块的错误码：
    - 服务不可用或连接异常：`SYS-IO-OSS-1001` 等；
    - 上传、删除失败：`SYS-IO-OSS-1004`, `SYS-IO-OSS-1005` 等。

## 七、接口层与错误码对齐

- 统一响应规范
  - API 层使用统一响应体结构（如 `code` + `message` + `data`）；
  - 错误码字段与《后端异常码对照表》保持一致，便于竞赛演示与问题定位。
  - 建议将请求与响应的「公共元信息」抽象为统一结构，便于网关链路追踪。

- 统一请求结构体（Request）
  - 字段列表
    - `requestId`（string，可选）：请求唯一标识，从网关或前端生成并透传；
    - `body`（object，必填）：具体业务请求参数对象，由各业务接口自行定义；
  - 约定说明
    - HTTP 层推荐同时在 Header 中携带 `REQUEST-ID`，与 body 内的 `requestId` 保持一致；
    - 当未携带 `REQUEST-ID` 时，可触发异常码 `RES-REQUEST-1004`；
    - 业务接口在日志与审计表中统一使用 `requestId` 字段进行链路关联。

- 统一响应结构体（Response）
  - 通用字段（正常与异常返回均适用）
    - `code`（integer，可选）：HTTP 语义上的状态码映射，例如 200 表示成功，非 200 表示失败；
    - `message`（string，可选）：本次请求的结果说明或错误提示信息；
    - `requestId`（string，可选）：与请求侧相同的请求 ID，便于端到端排查；
  - 正常返回结构（Normal Code）
    - `data`（object，可选）：本次请求的业务数据载荷，结构由具体接口定义；
    - 示例：

      ```json
      {
        "code": 200,
        "message": "OK",
        "requestId": "2025-10-21T12:00:00.123+08:00#abc123",
        "data": {
          "items": [],
          "total": 0
        }
      }
      ```

  - 异常返回结构（Error Code）
    - `errorCode`（string，必填）：后端异常码，对应《后端异常码对照表.csv》中的 ErrorCode 列，例如 `RES-REQUEST-1001`；
    - 当为异常返回时，一般不返回 `data` 字段，或将其置为空；
    - 示例：

      ```json
      {
        "code": 500,
        "message": "接口不存在",
        "requestId": "2025-10-21T12:00:00.123+08:00#abc123",
        "errorCode": "RES-REQUEST-1001"
      }
      ```

  - 设计原则
    - 前端以 `code` 字段判断成功/失败（例如 `code == 200` 视为成功），以 `errorCode` 进行精细化错误处理；
    - 运维与排错以 `errorCode` + `requestId` 为主键查询日志与链路；
    - `errorCode` 必须在接口文档与本文件中完整描述，以保证与异常码表对齐。

- 全局异常处理
  - 在 `wise-deopt-api` 中实现全局异常处理器，将系统异常、业务异常、参数校验异常转换为统一结构；
  - 认证、文件上传、MinIO 访问等异常要映射到对应模块的错误码：
    - AUTH 模块：登录、令牌、二步验证、工牌认证相关；
    - OSS 模块：上传、下载、临时链接、文件状态相关；
    - 通用 RES/SYS/VAL 模块：请求解析失败、接口不存在、方法不可用等。

## 八、部署拓扑建议

在竞赛/展示环境下，推荐采用简化的单机或双机部署方案：

- 基础部署结构
  - 应用层：
    - 1 个 Spring Boot 实例（`wise-deopt-api` 可执行 jar），提供全部业务接口；
  - 数据层：
    - 1 个 MySQL 实例，内部划分多个逻辑数据库（user/auth/inventory/...）；
  - 缓存与协调：
    - 1 个 Redis 实例，支撑会话、缓存与分布式控制；
  - 对象存储：
    - 1 个 MinIO 实例（单节点或简化分布式），挂载本地或网络存储磁盘。

- 网络与安全
  - 所有对外访问统一经由 API 层（可前置 Nginx 或网关），内部 Redis/MySQL/MinIO 不直接暴露到外网；
  - 在演示环境中可适当放宽网络限制，但需保留基本鉴权与错误码反馈机制。

## 九、与现有规划的对应关系小结

- 功能需求（《需求列表》）
  - 首页 KPI、未处理告警、巡检任务、差异复核、报表等功能由多个业务模块协同完成；
  - Redis 提供实时统计和状态缓存，MySQL 提供最终落盘数据，MinIO 提供图片/视频/报表等文件数据。

- 数据结构（《数据库设计表》）
  - 各「所属数据库」对应一个 MySQL 逻辑库，各「所属服务」对应一个领域/应用子模块；
  - `minio_file` 与监控、报表等表形成对象存储与关系数据的桥梁。

- 异常与错误码（《后端异常码对照表》）
  - AUTH 模块错误码用于认证与授权；
  - OSS 模块错误码用于 MinIO 及文件上传/下载相关异常；
  - 通用 RES/SYS/VAL 错误码用于接口级、系统级异常。

本架构规划后续可随着实际实现细化，在不改变「Spring Boot 模块化 + MySQL + Redis + MinIO」这一主干技术路线的前提下，逐步补充技术选型细节（ORM 框架、消息队列是否引入等）与运维配置。
